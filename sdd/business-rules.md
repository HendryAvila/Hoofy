> ⚡ Auto-generated by sdd_reverse_engineer — review and refine as needed

# Hoofy — Business Rules

> Generated by [SDD-Hoffy](https://github.com/HendryAvila/Hoofy) | Stage 3: Business Rules
>
> Business rules are the DNA of your system. They define what is acceptable
> and what is not — across ALL processes, not tied to any single feature.
> (Source: Business Rules Manifesto, Ronald Ross, v2.0)

## Definitions (Ubiquitous Language)

> Terms that everyone in the project must use consistently.
> (Source: Domain-Driven Design, Eric Evans — Ubiquitous Language)

- **Observation**: A persistent memory unit containing a title, content (max 2000 chars), type, scope, and optional metadata (project, session_id, topic_key, namespace). The atomic unit of knowledge in Hoofy's memory system.
- **Session**: A bounded coding activity with start time, end time, project association, and optional summary. Sessions group observations temporally.
- **Stage**: A discrete step in either the Project Pipeline or Change Pipeline. Each stage has a status (pending, in_progress, completed) and produces a markdown artifact.
- **Clarity Gate**: A quality checkpoint at the `clarify` stage that evaluates requirements across 8 dimensions and blocks advancement until the weighted average score meets the mode threshold.
- **Change**: A scoped modification to a project, classified by type (feature/fix/refactor/enhancement) and size (small/medium/large), which determines the required pipeline stages.
- **Flow**: A specific sequence of stages determined by the Change's type × size combination. There are 12 possible flows.
- **Topic Key**: A normalized identifier used for observation upsert semantics — when saving an observation with an existing topic_key, it updates the latest matching observation instead of creating a new one.
- **Namespace**: An isolation boundary for memory observations in multi-agent scenarios. Observations in one namespace are invisible to queries in another.
- **ADR (Architecture Decision Record)**: A structured record capturing an architectural decision with context, decision, rationale, alternatives rejected, and status (proposed/accepted/deprecated/superseded).
- **Composition Root**: The single location (`server.go`) where all dependencies are wired together via constructor injection, following the Dependency Inversion Principle.
- **Slug**: A URL-safe, lowercase identifier derived from a change description by replacing spaces/special chars with hyphens (e.g., "Fix FTS5 crash" → "fix-fts5-crash").

## Facts

> Relationships between terms that are always true.
> (Source: BRG Taxonomy — structural assertions)

- A Project has exactly one Pipeline with 8 ordered Stages.
- A Project has zero or more Changes, but at most one active Change at any time.
- A Change has exactly one Flow, determined by its type × size combination.
- A Flow contains 4 to 7 ordered Stages, always including context-check at index 1 and verify as the final stage.
- A Stage produces exactly one markdown artifact file.
- The Memory system contains zero or more Sessions.
- A Session contains zero or more Observations.
- An Observation belongs to at most one Session and at most one Namespace.
- An Observation can have zero or more Relations to other Observations.
- A Relation is typed (relates_to, implements, depends_on, caused_by, supersedes, part_of) and directional (from → to).
- An ADR belongs to exactly one Change.
- A completed Change can be archived to history, moving its directory from `sdd/changes/` to `sdd/history/`.
- The Clarity Gate evaluates exactly 8 dimensions, each scored 0-100.

## Constraints

> Behavioral boundaries. Format: When <condition> Then <imposition> [Otherwise <consequence>]
> (Source: Business Rules Manifesto, BRG — action assertions)

- When a Stage is not `completed`, Then the next Stage in sequence cannot be started (sequential enforcement).
- When the Clarity Gate score is below threshold (Guided: 70, Expert: 50), Then the pipeline MUST NOT advance past the `clarify` stage.
- When a Change is active, Then no new Change can be created until the active one is completed or abandoned.
- When an Observation's content exceeds 2000 characters, Then it MUST be truncated or rejected.
- When saving an Observation with a topic_key that matches an existing Observation within the deduplication window (15 min), Then the existing Observation is updated instead of creating a new one.
- When saving an Observation with identical normalized content hash within the deduplication window, Then the duplicate is rejected.
- When a user input is passed to FTS5 MATCH, Then it MUST be sanitized to prevent syntax errors and injection.
- When the `sdd_bootstrap` tool encounters an existing artifact file, Then it MUST skip that file without overwriting.
- When Memory initialization fails, Then SDD tools continue working but memory tools are not registered.
- When performing self-update, Then binary replacement MUST be atomic (write temp file, then rename) to prevent corruption.
- When writing user-facing output, Then it MUST go to stderr, not stdout (stdout is reserved for MCP stdio transport).


## Derivations

> Knowledge computed or inferred from facts and constraints.
> (Source: BRG Taxonomy — derivations)

- A Change's required stages are derived from the FlowRegistry lookup of its type × size combination.
- A Clarity Gate score is derived as the weighted average of all 8 dimension scores (equal weights).
- A Slug is derived from a Change description by: lowercasing, replacing non-alphanumeric chars with hyphens, collapsing consecutive hyphens, trimming leading/trailing hyphens.
- An Observation's deduplication hash is derived from normalizing its content (trimming whitespace, lowercasing) and computing a hash.
- Pipeline completeness is derived from the count of `completed` stages divided by total stages.
- A Stage's artifact filename is derived from the stage constant via the `stageFilenames` mapping (e.g., `StagePropose` → `proposal.md`).



## Glossary

> Additional domain terms and abbreviations beyond the core definitions.

- **MCP**: Model Context Protocol — a standard for AI tool integration via JSON-RPC over stdio/HTTP
- **FTS5**: Full-Text Search 5 — SQLite's full-text search extension
- **WAL**: Write-Ahead Logging — SQLite journaling mode for improved concurrent read performance
- **SDD**: Spec-Driven Development — Hoofy's methodology of writing specifications before code
- **MoSCoW**: Must/Should/Could/Won't — prioritization framework for requirements
- **DIP**: Dependency Inversion Principle — depend on abstractions, not concretions
- **SRP**: Single Responsibility Principle — one reason to change per module
- **CGO**: C-Go interop — disabled in Hoofy for static binary compilation
- **GoReleaser**: Tool for building and releasing Go binaries across platforms
- **ADR**: Architecture Decision Record — a lightweight documentation format for architectural decisions
- **ldflags**: Linker flags — used to inject version string at build time

