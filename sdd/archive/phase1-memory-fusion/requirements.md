# SDD-Hoffy Memory Fusion — Requirements

> Generated by [SDD-Hoffy](https://github.com/HendryAvila/sdd-hoffy) | Stage 2: Specify

## Functional Requirements

### Must Have

- **FR-001**: Embed SQLite+FTS5 store using `modernc.org/sqlite` (pure Go, no CGO) with schema for observations, sessions, and FTS5 virtual table
- **FR-002**: `mem_save` tool — save observations with title, content, type, project, scope, session_id, and optional topic_key for upserts
- **FR-003**: `mem_search` tool — full-text search across observations with filters (project, type, scope, limit)
- **FR-004**: `mem_context` tool — retrieve recent observations for a project, providing session continuity
- **FR-005**: `mem_session_start` / `mem_session_end` tools — session lifecycle management with timestamps
- **FR-006**: `mem_session_summary` tool — save structured end-of-session summaries (Goal/Discoveries/Accomplished/Files format)
- **FR-007**: `mem_timeline` tool — progressive disclosure: show chronological context around a specific observation
- **FR-008**: `mem_get_observation` tool — retrieve full untruncated content of a specific observation by ID
- **FR-009**: `mem_stats` tool — return memory system statistics (total sessions, observations, projects)
- **FR-010**: Topic key upserts — when saving with a topic_key, update the latest matching observation instead of creating a duplicate
- **FR-011**: Deduplication — prevent duplicate saves using content hash + 15-minute time window
- **FR-012**: All 8 existing SDD tools continue to function identically (zero regression)
- **FR-013**: Memory DB stored at `~/.sdd-hoffy/memory.db` with auto-creation on first use

### Should Have

- **FR-014**: `mem_save_prompt` tool — save user prompts to memory for intent tracking across sessions
- **FR-015**: `mem_delete` tool — soft-delete observations (with optional hard delete)
- **FR-016**: `mem_update` tool — update existing observations by ID (partial updates)
- **FR-017**: `mem_suggest_topic_key` tool — suggest stable topic keys for memory upserts based on title/content
- **FR-018**: SDD-Memory bridge — auto-save compact summaries to memory when SDD pipeline stages complete (using topic_key upserts so each stage has one evolving observation)
- **FR-019**: Enhanced `sdd_get_context` with `detail_level` parameter (summary/standard/full) for progressive disclosure
- **FR-020**: Memory protocol injection via MCP server instructions — tell the AI WHEN to save/search memories proactively

### Could Have

- **FR-021**: Privacy tag stripping — remove `<private>...</private>` content before persisting to memory
- **FR-022**: Cross-project search — search memories across all projects, not just the current one
- **FR-023**: Memory export/import via JSON for backup and migration
- **FR-024**: `mem_decision_log` tool — specialized tool for capturing architecture decisions in ADR format with searchable metadata

### Won't Have (this version)

- **FR-025**: TUI (Bubbletea terminal interface) — out of scope, MCP-only
- **FR-026**: HTTP API server — out of scope, stdio transport only
- **FR-027**: Git Sync — out of scope for v1, potential future feature
- **FR-028**: Per-project memory databases — v1 uses a single global DB at ~/.sdd-hoffy/
- **FR-029**: Multi-tenant / multi-user support — single-user tool

## Non-Functional Requirements

- **NFR-001**: Binary must compile with `CGO_ENABLED=0` — pure Go SQLite via modernc.org/sqlite
- **NFR-002**: Binary size must stay under 30MB (current ~8MB + SQLite overhead)
- **NFR-003**: All existing tests must pass with zero modifications (backward compatibility)
- **NFR-004**: Memory operations (save, search) must complete in under 100ms for databases up to 100K observations
- **NFR-005**: FTS5 search must handle queries with special characters without crashing (sanitize user input)
- **NFR-006**: Test coverage for new memory code must be ≥ 80%
- **NFR-007**: Database migrations must be forward-compatible — schema changes via versioned migrations
- **NFR-008**: Memory store must be safe for concurrent read access (single-writer, multiple-reader via SQLite WAL mode)
- **NFR-009**: Cross-platform builds: linux/darwin/windows on amd64/arm64 (matches current GoReleaser config)

## Constraints

- Must use `modernc.org/sqlite` (not `mattn/go-sqlite3`) to maintain CGO_ENABLED=0 static builds
- Must use existing `mcp-go v0.44.0` SDK — no SDK version changes
- Must maintain current CLI interface (`serve`, `update`, `version` commands)
- GoReleaser config must continue to produce working binaries for all 6 platform targets
- Cannot modify existing SDD pipeline stage order or Clarity Gate thresholds

## Assumptions

- Users have filesystem write access to `~/.sdd-hoffy/` directory
- SQLite WAL mode is supported on all target platforms
- `modernc.org/sqlite` FTS5 support works identically to CGO sqlite3 FTS5
- Engram's store.go patterns (dedup, topic_key upserts, FTS5 sanitization) are production-tested and reliable
- MCP clients support the increased number of tools (~20 vs current 8) without UX degradation
- Binary size increase from SQLite is acceptable to users (estimated 15-20MB increase)

## Dependencies

- `modernc.org/sqlite` v1.45+ — pure Go SQLite implementation with FTS5 support
- `mcp-go v0.44.0` — MCP SDK (already a dependency)
- Engram source code (MIT license) — reference/adapt `internal/store/store.go` for the memory store implementation
- GitHub Actions CI — must continue to pass with new dependency
