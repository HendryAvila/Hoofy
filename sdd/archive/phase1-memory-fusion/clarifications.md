# SDD-Hoffy Memory Fusion — Clarifications

> Generated by [SDD-Hoffy](https://github.com/HendryAvila/sdd-hoffy) | Stage 3: Clarify (Clarity Gate)

## Clarity Score: 82/100

**Mode:** expert | **Threshold:** 50 | **Status:** PASSED

---

## Clarification Rounds


### Round 3

### Q1: What is the exact database schema for observations and sessions?
**Answer**: Adapted from Engram's proven schema:
- **observations** table: id (INTEGER PK), session_id (TEXT), title (TEXT), content (TEXT NOT NULL), type (TEXT DEFAULT 'manual'), project (TEXT), scope (TEXT DEFAULT 'project'), topic_key (TEXT), content_hash (TEXT), is_deleted (BOOLEAN DEFAULT FALSE), created_at (DATETIME), updated_at (DATETIME)
- **sessions** table: id (TEXT PK), project (TEXT), directory (TEXT), started_at (DATETIME), ended_at (DATETIME), summary (TEXT)
- **observations_fts** virtual table: FTS5 on title + content columns for full-text search
- Indexes: on project, session_id, topic_key, content_hash, is_deleted, type

### Q2: What happens when the database is corrupted or inaccessible?
**Answer**: Memory operations should fail gracefully without affecting SDD pipeline operations. The SDD pipeline uses filesystem (`sdd/sdd.json` + markdown files) and is independent of the memory DB. If the memory DB can't be opened or is corrupted:
- Memory tools return clear error messages ("memory database unavailable: <reason>")
- SDD tools continue to work normally — they don't depend on the memory store
- On next successful connection, auto-run `PRAGMA integrity_check` and log warnings to stderr
- No automatic repair — user must delete and recreate the DB if corrupted

### Q3: How do we handle concurrent access to the memory database?
**Answer**: SQLite WAL mode allows concurrent reads with a single writer. Since MCP servers are single-process (one stdio connection), true concurrent writes won't occur. However, if a user accidentally runs two instances:
- SQLite's built-in locking handles this — the second writer will get SQLITE_BUSY
- Set a busy timeout of 5 seconds to handle brief lock contention
- If timeout expires, return an error to the MCP client ("memory database is locked by another process")

### Q4: Are there security concerns with storing user prompts and observations?
**Answer**: This is a local dev tool — all data stays on the user's machine at `~/.sdd-hoffy/memory.db`. Security posture:
- No network transmission of memory data (stdio transport only)
- File permissions: create DB with 0600 (owner read/write only)
- Privacy tag stripping (FR-021) is Could Have — not critical for v1 since data is local
- Users are responsible for not committing the DB to version control (add to .gitignore templates)
- No encryption at rest for v1 — SQLite file is readable by anyone with file access

### Q5: What happens when the `~/.sdd-hoffy/` directory doesn't exist?
**Answer**: Auto-create the directory with 0700 permissions on first use of any memory tool. Same pattern as Engram.

**Clarity Score after this round:** 82/100

